---
title: "Closing the Loop"
author: "Charles Lang"
date: "1/5/2021"
output: html_document
---

*WARNING: This project may not work from within China, if you are unable to install or make any of these services work please let Charles know ASAP*

## Twitter Setup

Step 1. Create a Twitter account at Twitter.com and register as a developer at the following link: https://developer.twitter.com/

Step 2. You will then need to register a new app (we need to create an app to access the API as that is what the primary us of the API is) at https://apps.twitter.com/

Step 3. Within R you will need to install the packages ROAuth and twitteR

Step 4. Copy the following details from your Twitter App page. Don't forget to put them in quotations!

```{r}
library(twitteR)
library(httr)
library(openssl)
library(httpuv)
library(base64enc)
api_key <- "jsZ54n7rUP6WkU5KufE0ejOBd"

api_secret <- "sb9vsQ3rQhixL4LBXKBlU193cErnWjFDQ5u6RGw1GslKdQycHA"

access_token <- "1686111846-1RETTikat9Pkdi0hH0intI2jdgw4lxSltcPmLWL"

access_token_secret <- "MlGbrugejrwpGPCd28R2EaT5eEkivTiN9lxjOoYKk9H4B"

setup_twitter_oauth(api_key, api_secret, access_token, access_token_secret)
origop <- options("httr_oauth_cache")
options(httr_oauth_cache = TRUE)
```

You can now download Tweets but remember you can only search from the previous 6-7 days. Limit the number of tweets you are searching for if you are searching for a popular term using `n=`

### Download Tweets
```{r}
library(ROAuth)
library(twitteR)

TL <- searchTwitter("educational data mining", n=50, since=as.character(Sys.Date()-6), until= as.character(Sys.Date()))#Make sure you change the dates here to be 6 days from today.
TL <- do.call("rbind", lapply(TL, as.data.frame))
```

You can now look at the data that Twitter has made available and do a quick visualization of your Tweets over time.

```{r}
counts=table(TL$screenName)
barplot(counts, las=2)

#By time of day
hist(TL$created, breaks = "d")
```

Using your Twitter data create an RMarkdown report including several visualizations. Using knitr to create an html document of your report. Save your html document to the working directory.

## Setup auto-email

To set up an autogenerated email you will need to install both the sendmailR and cronR packages. The cronR package is a scheduling package that connects to the cron system on your computer while sendmailR gives you access to your gmail account. You may have to hcnage the security settings on your gmail account to make this package work.

```{r}
#install.packages("sendmailR")
#install.packages("cronR")
#library(sendmailR)
#library(taskscheduleR)

#Email  
#sendmail_options(smtpServer="ASPMX.L.GOOGLE.COM")
#address <- as.character("dislu8198@gmail.com")
#address <- paste("<", address, ">", sep = "")

#Server<-list(smtpServer= "smtp.example.io")

#from <- "<arvind8198@gmail.com>"
#to <- "<dislu8198@gmail.com>"
#subject <- "SUBJECT"
#body <- c(
#  "Description."
#)
# you need to create google app for this approach
library(gmailr)
#This email will end up in your spam folder
#sendmail(from, to, subject, body,control=list(smtpServer= "ASPMX.L.GOOGLE.COM",port=465))


## edit line below to reflect YOUR json credential filename
gm_auth_configure(path="/Users/arvind tomar/Documents/loop-closing-master/autogenerator.json")

## edit below with email addresses from your life
test_email <- gm_mime(
  To = "dislu8198@gmail.com", # edit to put your                                    mail here
  From = "arvind8198@gmail.com",
  Subject = "this is just a gmailr test",
  body = "Can you hear me now?")

gm_send_message(test_email)
```

Investigate the Chron Scheduler 

Mac Users: Open the cronR scheduler by going to the `RStudio Tools` menu -> `Addins` -> `cronR` and hit `execute`. Point cronR at the R script you just created for gmailr and choose to send immediately.

https://www.bnosac.be/index.php/blog/51-new-rstudio-add-in-to-schedule-r-scripts

Windows users: Can use the built-in Task Scheduler application:

https://rstudio-pubs-static.s3.amazonaws.com/197242_31c29cf17f2c424d83d23bdc52a18c70.html

Use the scheduler to schedule an email to yourself (you may need to check your spam folder if it doesn't arrive)
```{r}
library(taskscheduleR)
taskscheduler_create(taskname = "test_run", 
                     rscript = "/Users/arvind tomar/Documents/loop-closing-master/schedule_script.r", 
                     schedule = "ONCE", 
                     starttime = format(Sys.time() + 50, "%H:%M"))
#taskscheduler_delete("test_run") #delete task before executing script again
```
## Threshold Generate

Can you set the scheduler to send an email triggered by an activity threshold on Twitter? For example, an email is sent if a certain number of Tweets are returned by your search.
```{r}
# Schedule an email triggered when number of tweets total crosses 5 in last 7 days
library(taskscheduleR)
taskscheduler_create(taskname = "MailTrigger_run", 
                     rscript = "/Users/arvind tomar/Documents/loop-closing-master/threshold_generator.r", 
                     schedule = "DAILY", 
                     starttime = format(Sys.time() + 50, "%H:%M"))
```

